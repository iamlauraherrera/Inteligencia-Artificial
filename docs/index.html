<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tres en Raya – Minimax (Python en el navegador)</title>
  <meta name="description" content="TicTacToe con Minimax en Python (Pyodide), publicado en GitHub Pages.">
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu; }
    body { display:flex; align-items:center; justify-content:center; min-height:100vh; background:#0f172a; color:#e5e7eb; margin:0; }
    .card { background:#111827; padding:24px; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); width:min(480px,92vw); }
    h1 { margin:0 0 12px; font-size:1.25rem; color:#fafafa; }
    .meta { color:#9ca3af; font-size:.92rem; margin-bottom:16px; display:flex; justify-content:space-between; gap:8px; }
    .board { display:grid; grid-template-columns:repeat(3,1fr); gap:10px; }
    .cell { aspect-ratio:1/1; display:flex; align-items:center; justify-content:center; font-size:2rem; border-radius:12px;
            background:#1f2937; color:#f9fafb; border:1px solid #374151; text-decoration:none; transition:transform .12s ease, background .2s ease; user-select:none; }
    .cell:hover { transform:translateY(-1px); background:#243041; cursor:pointer; }
    .disabled { pointer-events:none; opacity:.65; }
    .win { background:#064e3b !important; border-color:#047857; box-shadow:0 0 18px rgba(34,197,94,.35); }
    .footer { display:flex; gap:8px; margin-top:16px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .btn { background:#2563eb; color:#fff; padding:10px 14px; border-radius:10px; text-decoration:none; border:0; cursor:pointer; }
    .btn.secondary { background:#374151; }
    .status { color:#cbd5e1; min-height:1.2em; }
    .msg.win { color:#22c55e; } .msg.draw { color:#f59e0b; } .msg.lose { color:#ef4444; }
    .small { font-size:.9rem; color:#94a3b8; }
  </style>
  <!-- Pyodide (Python en el navegador) -->
  <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>
</head>
<body>
  <div class="card">
    <h1>Tres en Raya – Minimax (Python)</h1>
    <div class="meta">
      <div>Tú: <strong id="jhumano">?</strong> | Bot: <strong id="jbot">?</strong></div>
      <div class="small">Publicación estática (GitHub Pages)</div>
    </div>

    <div id="board" class="board" aria-label="Tablero 3x3"></div>

    <div class="footer">
      <div class="status"><span id="statusText"></span></div>
      <div style="display:flex; gap:8px;">
        <button id="btnAlt" class="btn secondary" type="button" title="Alternar quién empieza">Alternar inicio</button>
        <button id="btnReset" class="btn" type="button">Reiniciar</button>
      </div>
    </div>
  </div>

<script>
const LINES = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
let pyodide = null;

// Estado UI
let board = Array(9).fill('-');
let human = localStorage.getItem('ttt_human') || 'X';     // alternancia persistente
let bot   = human === 'X' ? 'O' : 'X';
let statusEl = document.getElementById('statusText');
let jhEl = document.getElementById('jhumano');
let jbEl = document.getElementById('jbot');
const boardEl = document.getElementById('board');

function updateMeta() {
  jhEl.textContent = human; jbEl.textContent = bot;
}
function winline(b) {
  for (const [a,b2,c] of LINES) { if (b[a] !== '-' && b[a]===b[b2] && b[a]===b[c]) return {line:[a,b2,c], win:b[a]}; }
  return {line:[], win:null};
}
function full(b) { return !b.includes('-'); }
function render() {
  boardEl.innerHTML = '';
  const {line, win} = winline(board);
  for (let i=0;i<9;i++) {
    const v = board[i];
    const cell = document.createElement('div');
    cell.className = 'cell';
    if (line.includes(i)) cell.classList.add('win');
    cell.textContent = v === '-' ? '' : v;
    if (v === '-' && !win && !full(board)) {
      cell.onclick = () => humanMove(i);
    } else {
      cell.classList.add('disabled');
    }
    boardEl.appendChild(cell);
  }
  if (win) statusEl.innerHTML = `<span class="msg ${win===human?'win':'lose'}">Gana ${win}</span>`;
  else if (full(board)) statusEl.innerHTML = `<span class="msg draw">¡Empate!</span>`;
  else statusEl.textContent = `Turno de ${turnOf()}`;
}
function turnOf() {
  const x = board.filter(c=>c==='X').length;
  const o = board.filter(c=>c==='O').length;
  return x===o ? 'X' : 'O';
}

async function ensurePy() {
  if (!pyodide) {
    pyodide = await loadPyodide();
    await pyodide.runPythonAsync(document.getElementById('pycode').textContent);
  }
}

async function humanMove(i) {
  if (board[i] !== '-' || winline(board).win || full(board)) return;
  if (turnOf() !== human) return; // evita clicks fuera de turno
  board[i] = human; render();
  if (winline(board).win || full(board)) return;
  await botMove();  // IA
}

async function botMove() {
  await ensurePy();
  // Llamamos a la función Python choose_move(board, bot, human)
  const move = await pyodide.runPythonAsync(`
from js import board_js, bot_js, human_js
choose_move(board_js.to_py(), bot_js, human_js)
  `, { globals: pyodide.toPy({}) });
}

document.getElementById('btnReset').onclick = async () => {
  board = Array(9).fill('-'); render();
  // Si empieza Bot (humano = 'O'), que haga su primer movimiento:
  if (human === 'O') {
    await ensurePy();
    await pyodide.runPythonAsync(`
from js import board_js, bot_js, human_js
choose_move(board_js.to_py(), bot_js, human_js)
    `);
  }
};
document.getElementById('btnAlt').onclick = () => {
  // Alternar quién empieza y persistir
  human = (human === 'X') ? 'O' : 'X';
  bot = (human === 'X') ? 'O' : 'X';
  localStorage.setItem('ttt_human', human);
  updateMeta();
  board = Array(9).fill('-');
  render();
  // Si ahora empieza el bot:
  if (human === 'O') {
    ensurePy().then(()=>pyodide.runPythonAsync(`
from js import board_js, bot_js, human_js
choose_move(board_js.to_py(), bot_js, human_js)
    `));
  }
};

// Variables compartidas JS→Python
Object.defineProperty(window, "board_js", { get(){ return board; }});
Object.defineProperty(window, "human_js", { get(){ return human; }});
Object.defineProperty(window, "bot_js",   { get(){ return bot; }});

// Inicializar
updateMeta(); render();
if (human === 'O') { ensurePy().then(()=>pyodide.runPythonAsync(`
from js import board_js, bot_js, human_js
choose_move(board_js.to_py(), bot_js, human_js)
`)); }
</script>

<!-- Código Python ejecutado en el navegador con Pyodide -->
<script id="pycode" type="text/plain">
# --- Minimax en Python para TicTacToe (versión web, sin input/print) ---
import math
from js import board_js, bot_js, human_js

LINES = [(0,1,2),(3,4,5),(6,7,8),(0,3,6),(1,4,7),(2,5,8),(0,4,8),(2,4,6)]

def winner(b):
    for a,b2,c in LINES:
        if b[a] != '-' and b[a]==b[b2]==b[c]:
            return b[a]
    return None

def actions(b):
    return [i for i,v in enumerate(b) if v=='-']

def terminal(b):
    return winner(b) is not None or '-' not in b

def minimax(b, player, max_player):
    other = 'O' if player=='X' else 'X'
    win = winner(b)
    if win is not None:
        # victoria del que jugó antes
        return {'pos': None, 'score': (1 if win==max_player else -1) * (len(actions(b))+1)}
    if '-' not in b:
        return {'pos': None, 'score': 0}

    best = {'pos': None, 'score': -math.inf if player==max_player else math.inf}
    for mv in actions(b):
        nb = b.copy(); nb[mv] = player
        sc = minimax(nb, other, max_player)
        sc = {'pos': mv, 'score': sc['score']}
        if player==max_player:
            if sc['score'] > best['score']: best = sc
        else:
            if sc['score'] < best['score']: best = sc
    return best

def choose_move(board, bot, human):
    # mueve bot solo si es su turno
    x = sum(1 for c in board if c=='X'); o = sum(1 for c in board if c=='O')
    turn = 'X' if x==o else 'O'
    if turn != bot: 
        return None
    best = minimax(board, bot, max_player=bot)
    pos = best['pos']
    if pos is not None and board[pos]=='-':
        board[pos] = bot
    return pos
</script>
</body>
</html>