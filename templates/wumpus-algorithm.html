<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Wumpus Probabilístico — Simulación</title>
<style>
:root { font-family: system-ui, -apple-system, Segoe UI, Roboto; }
body { margin:0; background:#0f172a; color:#e5e7eb; }
header{ padding:12px 16px; background:#111827; border-bottom:1px solid #1f2937; }
h1{ margin:0; font-size:1.05rem; color:#fafafa; }
.wrap{ max-width:1100px; margin:16px auto; padding:0 16px; display:grid; grid-template-columns: 1fr 380px; gap:14px; }
.card{ background:#111827; border:1px solid #1f2937; border-radius:12px; padding:12px; }
.title{ font-weight:600; margin-bottom:6px; color:#fafafa; }
.grid{ display:grid; gap:2px; background:#0b101d; padding:6px; border-radius:10px; user-select:none; }
.cell{ position:relative; aspect-ratio:1/1; border-radius:6px; background:#1f2937; display:flex; align-items:center; justify-content:center; }
.cell .txt-br{ position:absolute; bottom:4px; right:4px; font-size:.7rem; color:#cbd5e1; opacity:.95; }   /* R: riesgo */
.cell .txt-tl{ position:absolute; top:4px; left:6px;   font-size:.7rem; color:#e5e7eb; opacity:.95; }   /* C: costo */
.row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
.btn{ background:#2563eb; border:1px solid #2563eb; color:#e5e7eb; border-radius:10px; padding:8px 12px; }
.btn.s{ background:#374151; border-color:#374151; }
.small{ color:#9ca3af; font-size:.9rem; }
.stat{ font-family: ui-monospace, Menlo, monospace; font-size:.95rem; color:#cbd5e1; }
.badge{ display:inline-flex; align-items:center; gap:6px; border:1px solid #374151; background:#1f2937; padding:2px 8px; border-radius:999px; font-size:.86rem; margin-right:6px; }
.dot{ width:12px; height:12px; border-radius:3px; display:inline-block; }
.agent{ background:#10b981 !important; }     /* verde */
.safe{ box-shadow: inset 0 0 0 2px #047857; } /* borde verde oscuro */
.vis{ background:#243041; }
.gold{ box-shadow: inset 0 0 0 2px #fbbf24; } /* amarillo */

/* Indicadores de sensores en la celda actual */
.stench:after { content:"S"; position:absolute; top:4px; right:6px; font-size:.75rem; color:#ef4444; }
.breeze:after { content:"B"; position:absolute; top:4px; right:18px; font-size:.75rem; color:#22c55e; }

/* Personajes (opcional mostrar) */
.pit::before   { content:"P"; position:absolute; font-weight:700; color:#ef4444; font-size:.9rem; }
.oro::before   { content:"G"; position:absolute; font-weight:700; color:#fbbf24; font-size:.9rem; }
</style>
</head>
<body>
<header><h1>Wumpus Probabilístico — Simulación</h1></header>

<div class="wrap">
  <div class="card">
    <div class="title">Cueva</div>
    <div id="board" class="grid"></div>
    <div class="small" style="margin-top:8px">
      <span class="badge"><span class="dot" style="background:#10b981"></span>Agente</span>
      <span class="badge"><span class="dot" style="background:#243041"></span>Visitado</span>
      <span class="badge"><span class="dot" style="background:#1f2937"></span>No visitado</span>
      <span class="badge"><span class="dot" style="background:#047857"></span>Seguro</span>
      <span class="badge"><span class="dot" style="background:#fbbf24"></span>Oro (G)</span>
      <span class="badge"><span class="dot" style="background:#ef4444"></span>Pozo (P)</span>
    </div>
  </div>

  <div class="card">
    <div class="title">Controles</div>
    <div class="row" style="margin-bottom:8px">
      <button class="btn" id="run">Auto</button>
      <button class="btn s" id="step">Paso</button>
      <button class="btn s" id="prev">◀</button>
      <button class="btn s" id="next">▶</button>
      <button class="btn s" id="clear">Reiniciar</button>
      <a class="btn s" href="/">Volver</a>
    </div>

    <div class="row" style="margin-bottom:8px">
      <label class="small">Densidad pozos:
        <input id="dens" type="range" min="0" max="35" value="15" />
        <span id="densv" class="small">15%</span>
      </label>
      <button class="btn s" id="rnd">Nuevo mundo</button>
    </div>

    <div class="row" style="margin-bottom:8px; gap:14px">
      <div class="small"><b>Mostrar:</b></div>
      <label class="small"><input type="checkbox" id="showGold"> Oro (G)</label>
      <label class="small"><input type="checkbox" id="showPits"> Pozos (P)</label>
      <label class="small"><input type="checkbox" id="showRisk" checked> Riesgo (R)</label>
      <label class="small"><input type="checkbox" id="showCost" checked> Costo (C)</label>
    </div>

    <div id="msg" class="small" style="margin-bottom:6px;"></div>

    <div class="title" style="margin-top:6px">Sensores</div>
    <div id="sensors" class="stat"></div>

    <div class="title" style="margin-top:6px">Estado</div>
    <div id="info" class="stat"></div>
  </div>
</div>

<script>
const name="wumpus-algorithm.py";
const board=document.getElementById('board');
const info=document.getElementById('info');
const sensors=document.getElementById('sensors');
const msg=document.getElementById('msg');
const dens=document.getElementById('dens'), densv=document.getElementById('densv');

const chkGold = document.getElementById('showGold');
const chkPits = document.getElementById('showPits');
const chkRisk = document.getElementById('showRisk');
const chkCost = document.getElementById('showCost');

let autoTimer=null;

dens.oninput=()=>{ densv.textContent = dens.value+"%"; };

async function j(u,o={}){const r=await fetch(u,o);return r.json();}
async function getS(){return j(`/api/${name}/state`);}
async function act(a){return j(`/api/${name}/act`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:a})});}

function rcFromIndex(i,n){ return [Math.floor(i/n), i % n]; }
function manhattan(i, j, n){
  const [r1,c1]=rcFromIndex(i,n), [r2,c2]=rcFromIndex(j,n);
  return Math.abs(r1-r2)+Math.abs(c1-c2);
}

function paint(st){
  const n = st.n || 6;
  board.innerHTML=''; board.style.gridTemplateColumns=`repeat(${n},1fr)`;

  // conjuntos para lookup
  const V = new Set(st.visitados||[]);
  const S = new Set(st.seguros||[]);
  const pits = new Set(st.pozos||[]);
  const A = st.agente;
  const oro = st.oro;           // lo mostraremos si se activa el checkbox o si ganó
  const pPit = st.p_pit || [];
  const pW = st.p_wumpus || [];

  for(let i=0;i<n*n;i++){
    const d=document.createElement('div');
    d.className='cell';
    if(V.has(i)) d.classList.add('vis');
    if(S.has(i)) d.classList.add('safe');

    // Personajes opcionales
    if(chkPits.checked && pits.has(i)) d.classList.add('pit');
    if((chkGold.checked || st.gano) && i===oro) d.classList.add('oro','gold');

    // Agente + sensores actuales
    if(i===A) {
      d.classList.add('agent');
      if (st.breeze) d.classList.add('breeze');  // "B"
      if (st.stench) d.classList.add('stench');  // "S"
    }

    // Overlays:
    // Costo C = distancia Manhattan hasta el oro (si oro existe)
    if(chkCost.checked && typeof oro === 'number'){
      const c = manhattan(i, oro, n);
      const tl=document.createElement('div');
      tl.className='txt-tl'; tl.textContent = `C:${c}`;
      d.appendChild(tl);
    }

    // Riesgo R = p_pit + (p_wumpus si vivo)
    if(chkRisk.checked){
      const pp = pPit[i] || 0, pw = (st.wumpus_vivo? (pW[i]||0) : 0);
      const risk = (pp + pw).toFixed(2);
      const br=document.createElement('div');
      br.className='txt-br'; br.textContent = `R:${risk}`;
      d.appendChild(br);
    }

    board.appendChild(d);
  }

  // sensores actuales (texto)
  const arr=[];
  if(st.breeze) arr.push("Brisa");
  if(st.stench) arr.push("Hedor");
  if(st.glitter) arr.push("Brillo (oro)");
  sensors.textContent = "Sensores: " + (arr.length? arr.join(", ") : "—");

  msg.textContent = st.msg || '';
  info.textContent = `Pasos=${st.pasos||0} • Vivo=${st.vivo? "Sí":"No"} • Oro=${st.tiene_oro? "Sí":"No"} • Wumpus=${st.wumpus_vivo? "Vivo":"Muerto"} • ${st.gano? "¡GANÓ!":""}`;
}

async function update(){ const {estado}=await getS(); paint(estado||{}); }

document.getElementById('run').onclick = ()=>{
  if(autoTimer){ clearInterval(autoTimer); autoTimer=null; return; }
  autoTimer=setInterval(()=> act('step').then(update), 250);
};
document.getElementById('step').onclick = ()=> act('step').then(update);
document.getElementById('prev').onclick = ()=> act('prev').then(update);
document.getElementById('next').onclick = ()=> act('next').then(update);
document.getElementById('clear').onclick= ()=> act('clear').then(update);

document.getElementById('rnd').onclick = async ()=>{
  const p = Math.max(0, Math.min(0.35, parseInt(dens.value,10)/100));
  await act(`random:${p}`);
  update();
};

// Redibuja cuando cambian los toggles de visualización
[chkGold, chkPits, chkRisk, chkCost].forEach(ch => ch.addEventListener('change', update));

update();
</script>
</body>
</html>