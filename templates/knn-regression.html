<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>KNN Regresión — kms vs precio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js para las gráficas -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    :root { --bg:#0b1020; --fg:#e7eaf0; --card:#151b31; --muted:#94a3b8; --accent:#7c3aed; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; background:var(--bg); color:var(--fg); }
    header { padding:16px 20px; background:#0c1226; border-bottom:1px solid #1f2948; }
    h1 { margin:0; font-size:20px; letter-spacing:.3px; }
    main { max-width:1100px; margin:0 auto; padding:20px; }
    .row { display:grid; gap:16px; grid-template-columns: 1.1fr .9fr; align-items:start; }
    .card { background:var(--card); border:1px solid #1f2948; border-radius:14px; padding:16px; }
    .card h2 { margin:0 0 8px; font-size:16px; }
    .controls { display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:10px; }
    .field { display:flex; flex-direction:column; gap:6px; }
    label { font-size:12px; color:var(--muted); }
    input { background:#0f1530; color:var(--fg); border:1px solid #253156; border-radius:10px; padding:10px 12px; outline:none; }
    input::placeholder{ color:#6b7280; }
    .btn { background:linear-gradient(90deg,#6d28d9,#2563eb); color:#fff; border:none; border-radius:12px; padding:12px 14px; cursor:pointer; font-weight:600; }
    .btn:disabled{ opacity:.6; cursor:not-allowed; }
    .stack { display:grid; gap:16px; }
    .charts { display:grid; gap:16px; }
    .two { display:grid; gap:16px; grid-template-columns:1fr 1fr; }
    .muted { color:var(--muted); font-size:13px; }
    canvas { width:100%; height:320px; background:#0f1530; border:1px solid #243055; border-radius:12px; }
    .footer { margin-top:18px; font-size:12px; color:#8c9bb3; text-align:center; }
    .split { display:flex; gap:10px; align-items:end; flex-wrap:wrap; }
  </style>
</head>
<body>
  <header>
    <h1>K-NN Regresión (kms → precio)</h1>
  </header>

  <main class="stack">

    <!-- Panel de generación -->
    <section class="card">
      <h2>Generar curvas y puntos</h2>
      <p class="muted" style="margin-bottom:12px">Carga tu <code>carros.csv</code> (columnas <b>kms</b> y <b>precio</b>), entrena KNN en datos escalados (MinMax) y visualiza puntos crudos + curva, y escalados + curva.</p>

      <div class="controls" style="margin-bottom:12px">
        <div class="field">
          <label for="csv_path">Ruta CSV</label>
          <input id="csv_path" value="carros.csv" placeholder="carros.csv" />
        </div>
        <div class="field">
          <label for="k">k (vecinos)</label>
          <input id="k" type="number" min="1" step="1" value="3" />
        </div>
        <div class="field">
          <label for="max_km">máx. kms curva</label>
          <input id="max_km" type="number" min="1000" step="1000" value="140000" />
        </div>
        <div class="field">
          <label for="step">paso (kms)</label>
          <input id="step" type="number" min="100" step="100" value="1000" />
        </div>
      </div>

      <div class="split">
        <button id="btn-train" class="btn">Generar</button>
        <span id="status" class="muted"></span>
      </div>
    </section>

    <!-- Gráficas -->
    <section class="charts two">
      <div class="card">
        <h2>Originales (kms vs precio)</h2>
        <canvas id="chart-crudos"></canvas>
      </div>
      <div class="card">
        <h2>Escalados (MinMax)</h2>
        <canvas id="chart-escalados"></canvas>
      </div>
    </section>

    <!-- Predicción puntual -->
    <section class="card">
      <h2>Predicción</h2>
      <div class="split">
        <div class="field" style="min-width:180px">
          <label for="kms_query">Kms a predecir</label>
          <input id="kms_query" type="number" min="0" step="1000" value="20000" />
        </div>
        <button id="btn-predict" class="btn">Predecir precio</button>
        <span id="pred-out" class="muted"></span>
      </div>
    </section>

    <div class="footer">Si ves una sola gráfica o 404, verifica que el botón “Generar” use <code>POST /api/knn</code> y que el servidor esté ejecutando ese endpoint.</div>
  </main>

  <script>
  // --- helpers y estado (sin colisiones globales) ---
  const byId = (id) => document.getElementById(id);
  let charts = {};

  async function postJSON(url, payload) {
    const r = await fetch(url, {
      method: "POST",
      headers: { "Content-Type":"application/json" },
      body: JSON.stringify(payload)
    });
    if (!r.ok) throw new Error(await r.text());
    return r.json();
  }

  function draw(canvasId, scatterX, scatterY, lineX, lineY, xLabel, yLabel) {
    const ctx = byId(canvasId).getContext("2d");
    const dataPts = scatterX.map((x,i)=>({x, y: scatterY[i]}));
    const dataLine = lineX.map((x,i)=>({x, y: lineY[i]}));
    if (charts[canvasId]) charts[canvasId].destroy();
    charts[canvasId] = new Chart(ctx, {
      type: "scatter",
      data: {
        datasets: [
          { label:"Puntos crudos", data:dataPts, pointRadius:3, showLine:false },
          { label:"Curva KNN", data:dataLine, type:"line", borderWidth:2, tension:0 }
        ]
      },
      options:{
        responsive:true,
        plugins:{ legend:{ labels:{ color:"#e7eaf0"} } },
        scales:{
          x:{ type:"linear", title:{ display:true, text:xLabel, color:"#94a3b8"}, ticks:{color:"#94a3b8"}, grid:{color:"#1e293b"} },
          y:{ type:"linear", title:{ display:true, text:yLabel, color:"#94a3b8"}, ticks:{color:"#94a3b8"}, grid:{color:"#1e293b"} }
        }
      }
    });
  }

  async function generar() {
    try {
      const st = byId("status");
      if (st) st.textContent = "Generando…";
      const csv_path = (byId("csv_path")?.value || "carros.csv").trim();
      const k       = parseInt(byId("k")?.value || "3", 10);
      const max_km  = parseInt(byId("max_km")?.value || "140000", 10);
      const step    = parseInt(byId("step")?.value || "1000", 10);

      const data = await postJSON("/api/knn", { csv_path, k, max_km, step });

      draw("chart-crudos",
           data.crudos.x, data.crudos.y,
           data.curva_raw.x, data.curva_raw.y,
           "Kms", "Precio ($)");

      draw("chart-escalados",
           data.escalados.x, data.escalados.y,
           data.curva_escalados.x, data.curva_escalados.y,
           "Kms (0–1)", "Precio (0–1)");

      if (st) st.textContent = "Listo.";
    } catch (e) {
      console.error(e);
      const st = byId("status");
      if (st) st.textContent = "Error: " + e.message;
    }
  }

  async function predecir() {
    try {
      const csv_path = (byId("csv_path")?.value || "carros.csv").trim();
      const k   = parseInt(byId("k")?.value || "3", 10);
      const kms = parseFloat(byId("kms_query")?.value || "0");
      const r = await postJSON("/api/predict", { csv_path, k, kms });
      const out = byId("pred-out");
      if (out) out.textContent = "Precio estimado: $" + Math.round(r.precio_pred).toLocaleString();
    } catch (e) {
      console.error(e);
      const out = byId("pred-out");
      if (out) out.textContent = "Error: " + e.message;
    }
  }

  // Enlazar eventos solo si existen (evita "cannot read addEventListener of null")
  document.addEventListener("DOMContentLoaded", () => {
    const btnTrain   = byId("btn-train");
    const btnPredict = byId("btn-predict");
    if (btnTrain)   btnTrain.addEventListener("click", generar);
    if (btnPredict) btnPredict.addEventListener("click", predecir);
  });
  </script>
</body>
</html>
