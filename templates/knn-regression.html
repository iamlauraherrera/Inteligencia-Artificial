<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>KNN Regresión (kms → precio)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Chart.js CDN -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root { --green:#16a34a; --red:#dc2626; --gray:#e5e7eb; --ink:#111827; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial; margin: 0; background:#fff; color:var(--ink); }
    header { padding: 16px 20px; border-bottom: 1px solid var(--gray); }
    .wrap { max-width: 980px; margin: 0 auto; padding: 20px; }
    .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: end; }
    .field { display:flex; flex-direction:column; gap:6px; }
    .field label { font-size:12px; color:#374151; }
    input[type="number"], input[type="text"] {
      padding: 10px 12px; border: 1px solid var(--gray); border-radius: 8px; min-width: 140px;
    }
    button { padding: 10px 14px; border-radius: 10px; border: 0; cursor: pointer; font-weight: 600; }
    .primary { background: var(--green); color: #fff; }
    .danger  { background: var(--red); color: #fff; }
    .secondary { background:#111827; color:#fff; }
    .muted { font-size:12px; color:#6b7280; }
    canvas { background: #fff; border:1px solid var(--gray); border-radius: 12px; }
    .bar { height:10px; width:100%; background:var(--gray); border-radius:6px; overflow:hidden; }
    .bar > div { height:100%; width:0%; background: linear-gradient(90deg,#60a5fa,#34d399); transition:width .3s; }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <h2>KNN Regresión (kms → precio)</h2>
    <div class="muted">Usa tu <code>carros.csv</code>, entrena y grafica la curva estimada.</div>
  </div>
</header>

<div class="wrap">
  <section class="row" style="margin-bottom:14px;">
    <div class="field">
      <label>CSV (ruta)</label>
      <input id="csv" type="text" value="carros.csv" />
    </div>
    <div class="field">
      <label>k (vecinos)</label>
      <input id="k" type="number" value="3" min="1" step="1" />
    </div>
    <div class="field">
      <label>&nbsp;</label>
      <button class="primary" id="btn-train">Entrenar</button>
    </div>
    <div class="field">
      <label>&nbsp;</label>
      <button class="danger" id="btn-reset">Detener / Reset</button>
    </div>
  </section>

  <section class="row" style="margin-bottom:14px;">
    <div class="field">
      <label>Max kms</label>
      <input id="maxkms" type="number" value="140000" min="1000" step="1000" />
    </div>
    <div class="field">
      <label>Paso</label>
      <input id="paso" type="number" value="1000" min="1" step="1" />
    </div>
    <div class="field">
      <label>&nbsp;</label>
      <button class="secondary" id="btn-curve">Generar curva</button>
    </div>
  </section>

  <section class="row" style="margin-bottom:16px;">
    <div class="field">
      <label>kms para predecir</label>
      <input id="kms" type="number" value="20000" min="0" step="500" />
    </div>
    <div class="field">
      <label>&nbsp;</label>
      <button id="btn-predict">Predecir precio</button>
    </div>
    <div class="field">
      <label>Resultado</label>
      <div id="out" class="muted">—</div>
    </div>
  </section>

  <div class="bar" style="margin:10px 0 18px;"><div id="prog"></div></div>

  <canvas id="chart" height="280"></canvas>
</div>

<script>
const $ = (s)=>document.querySelector(s);
const prog = $("#prog");

let chart;
function ensureChart() {
  const ctx = document.getElementById('chart').getContext('2d');
  if (chart) return chart;
  chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: [],
      datasets: [
        {
          label: 'Curva KNN (precio estimado)',
          data: [],
          borderWidth: 2,
          tension: 0.25
        }
      ]
    },
    options: {
      responsive: true,
      scales: {
        x: { title: { display: true, text: 'Kms' } },
        y: { title: { display: true, text: 'Precio ($)' }, ticks: { callback: v => '$' + v.toLocaleString() } }
      },
      plugins: { legend: { display: true } }
    }
  });
  return chart;
}

async function postJSON(url, body) {
  prog.style.width = '25%';
  const res = await fetch(url, {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(body||{})
  });
  prog.style.width = '60%';
  const j = await res.json();
  prog.style.width = '100%';
  setTimeout(()=>prog.style.width='0%', 400);
  return j;
}
async function getJSON(url) {
  prog.style.width = '25%';
  const res = await fetch(url);
  prog.style.width = '60%';
  const j = await res.json();
  prog.style.width = '100%';
  setTimeout(()=>prog.style.width='0%', 400);
  return j;
}

// Entrenar
$("#btn-train").addEventListener('click', async ()=>{
  const csv = $("#csv").value.trim() || "carros.csv";
  const k = parseInt($("#k").value || '3', 10);
  const r = await postJSON('/algo/knn-regression.py/train', { csv, k });
  if (!r.ok) { alert(r.error || 'Error al entrenar'); return; }
  alert(`Modelo entrenado\nCSV: ${r.csv}\nk: ${r.k}`);
});

// Curva
$("#btn-curve").addEventListener('click', async ()=>{
  const maxkms = parseInt($("#maxkms").value || '140000', 10);
  const paso = parseInt($("#paso").value || '1000', 10);
  const r = await getJSON(`/algo/knn-regression.py/curve?max_kms=${maxkms}&paso=${paso}`);
  if (!r.ok) { alert(r.error || 'Primero entrena el modelo'); return; }

  const ch = ensureChart();
  ch.data.labels = r.xs;
  ch.data.datasets[0].data = r.ys;
  ch.update();
});

// Predecir
$("#btn-predict").addEventListener('click', async ()=>{
  const kms = parseFloat($("#kms").value || '20000');
  const r = await getJSON(`/algo/knn-regression.py/predict?kms=${kms}`);
  if (!r.ok) { alert(r.error || 'Primero entrena el modelo'); return; }
  $("#out").textContent = `$ ${r.precio.toLocaleString(undefined,{maximumFractionDigits:0})}`;
});

// Reset (simple: limpia la gráfica)
$("#btn-reset").addEventListener('click', ()=>{
  if (!chart) return;
  chart.data.labels = [];
  chart.data.datasets[0].data = [];
  chart.update();
  $("#out").textContent = '—';
});
</script>
</body>
</html>