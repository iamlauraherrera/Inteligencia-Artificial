<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>A* — Visualizador estilo Tech With Tim</title>
<style>
:root { font-family: system-ui, -apple-system, Segoe UI, Roboto; }
body { margin:0; background:#0f172a; color:#e5e7eb; }
header{ padding:12px 16px; background:#111827; border-bottom:1px solid #1f2937; }
h1{ margin:0; font-size:1.05rem; color:#fafafa; }
.wrap{ max-width:1000px; margin:16px auto; padding:0 16px; display:grid; grid-template-columns: 1fr 360px; gap:14px; }
.card{ background:#111827; border:1px solid #1f2937; border-radius:12px; padding:12px; }
.title{ font-weight:600; margin-bottom:6px; color:#fafafa; }
.grid{ display:grid; gap:1px; background:#0b101d; padding:6px; border-radius:10px; user-select:none; }
.cell{ aspect-ratio:1/1; border-radius:2px; background:#1f2937; }
.cell:hover{ filter:brightness(1.07); cursor:pointer; }
.row{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
.btn{ background:#2563eb; border:1px solid #2563eb; color:#e5e7eb; border-radius:10px; padding:8px 12px; }
.btn.s{ background:#374151; border-color:#374151; }
.small{ color:#9ca3af; font-size:.9rem; }
.stat{ font-family: ui-monospace, Menlo, monospace; font-size:.95rem; color:#cbd5e1; }
.badge{ display:inline-flex; align-items:center; gap:6px; border:1px solid #374151; background:#1f2937; padding:2px 8px; border-radius:999px; font-size:.86rem; margin-right:6px; }
.dot{ width:12px; height:12px; border-radius:3px; display:inline-block; }
.warn{ color:#f59e0b; }
</style>
</head>
<body>
<header><h1>A* — Visualizador estilo Tech With Tim (Flask)</h1></header>

<div class="wrap">
  <div class="card">
    <div class="title">Grilla</div>
    <div id="board" class="grid"></div>
    <div style="margin-top:8px">
      <span class="badge"><span class="dot" style="background:#1f2937"></span>Libre</span>
      <span class="badge"><span class="dot" style="background:#000000"></span>Pared</span>
      <span class="badge"><span class="dot" style="background:#f59e0b"></span>Origen</span>
      <span class="badge"><span class="dot" style="background:#22d3ee"></span>Meta</span>
      <span class="badge"><span class="dot" style="background:#ef4444"></span>Cerrado</span>
      <span class="badge"><span class="dot" style="background:#22c55e"></span>Abierto</span>
      <span class="badge"><span class="dot" style="background:#a78bfa"></span>Actual</span>
      <span class="badge"><span class="dot" style="background:#8b5cf6"></span>Camino</span>
    </div>
  </div>

  <div class="card">
    <div class="title">Controles</div>
    <div class="row" style="margin-bottom:8px">
      <button class="btn" id="run" disabled>Ejecutar (Espacio)</button>
      <button class="btn s" id="prev">◀</button>
      <button class="btn s" id="next">▶</button>
      <button class="btn s" id="auto">Auto</button>
      <button class="btn s" id="clear">Limpiar (C)</button>
      <a class="btn s" href="/">Volver</a>
    </div>

    <div class="row" style="margin-bottom:8px">
      <label class="small">Pared aleatoria:
        <input id="dens" type="range" min="0" max="60" value="30" />
        <span id="densv" class="small">30%</span>
      </label>
      <button class="btn s" id="rnd">Aleatorio</button>
    </div>

    <div class="small">
      <b>Izq arrastre:</b> pared • <b>Der arrastre:</b> borrar • <b>Shift+Click:</b> origen • <b>Alt+Click:</b> meta •
      <b>Espacio:</b> ejecutar • <b>C:</b> limpiar
    </div>
    <div id="msg" class="small warn" style="margin-top:6px;"></div>

    <div class="title" style="margin-top:10px">Estado</div>
    <div id="info" class="stat"></div>
    <div id="cost" class="stat"></div>
  </div>
</div>

<script>
const name="a-algorithm.py";
const board=document.getElementById('board');
const info=document.getElementById('info');
const cost=document.getElementById('cost');
const msg=document.getElementById('msg');
const btnRun=document.getElementById('run');
const slider=document.getElementById('dens'), densv=document.getElementById('densv');

let autoTimer=null;
let isDragging=false;
let dragValue=null; // 1=pared, 0=libre
let batch=[], batchTimer=null;

slider.oninput=()=>{ densv.textContent = slider.value+"%"; };

async function j(u,o={}){const r=await fetch(u,o);return r.json();}
async function getS(){return j(`/api/${name}/state`);}
async function act(a){return j(`/api/${name}/act`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:a})});}

function color(i,st){
  const {origen,meta,cells,visitados=[],frontera=[],actual=null,path=[],path_parcial=[]}=st;
  if(i===origen) return '#f59e0b';
  if(i===meta)   return '#22d3ee';
  if(path.includes(i)||path_parcial.includes(i)) return '#8b5cf6';
  if(actual===i) return '#a78bfa';
  if(visitados.includes(i)) return '#ef4444';
  if(frontera.includes(i))  return '#22c55e';
  return (cells[i]===1)?'#000000':'#1f2937';
}

function validRun(st){
  if(st.origen==null || st.meta==null) return "Debe fijar origen y meta (Shift/Alt + clic).";
  if(st.cells[st.origen]===1) return "El origen no puede ser una pared.";
  if(st.cells[st.meta]===1)   return "La meta no puede ser una pared.";
  return "";
}

function sendBatchSoon(){
  if(batch.length===0) return;
  if(batchTimer) return;
  batchTimer = setTimeout(async ()=>{
    const val = dragValue ?? 1;
    const uniq = Array.from(new Set(batch)); batch = [];
    const csv = uniq.join(',');
    await act(`bulk:${val}:${csv}`);
    batchTimer = null;
    update();
  }, 25); // ~40 fps
}

function paint(st){
  const n=st.n||50;
  board.innerHTML=''; board.style.gridTemplateColumns=`repeat(${n},1fr)`;
  for(let i=0;i<n*n;i++){
    const d=document.createElement('div'); d.className='cell';
    d.style.background=color(i,st);

    d.onmousedown=(ev)=>{
      ev.preventDefault();
      if(ev.shiftKey){ act(`set_origen:${i}`).then(update); return; }
      if(ev.altKey){ act(`set_meta:${i}`).then(update); return; }
      isDragging=true;
      dragValue = (ev.button===2) ? 0 : 1;   // izq=pared(1), der=borrar(0)
      batch.push(i); sendBatchSoon();
    };
    d.onmouseenter=()=>{
      if(!isDragging) return;
      batch.push(i); sendBatchSoon();
    };
    d.oncontextmenu=(e)=>{ e.preventDefault(); };
    board.appendChild(d);
  }
  document.onmouseup=()=>{ isDragging=false; dragValue=null; };

  const idx=(st.frame_idx??0)+1, tot=st.frames_len??0;
  info.textContent=`${st.msg||''} ${tot?`• Frame ${idx}/${tot}`:''} • Visitados=${(st.visitados||[]).length} • Frontera=${(st.frontera||[]).length} • Camino=${(st.path||[]).length}`;
  cost.textContent=(st.g_actual!=null&&st.f_actual!=null)?`Nodo actual: g=${st.g_actual}  f=${st.f_actual}`:'';

  const warn = validRun(st);
  msg.textContent = warn;
  btnRun.disabled = !!warn;
}

async function update(){ const {estado}=await getS(); paint(estado||{}); }

document.getElementById('rnd').onclick = async ()=>{
  const p = Math.max(0, Math.min(0.6, parseInt(slider.value,10)/100)); // 0..0.6
  await act(`random:${p}`);
  update();
};

btnRun.onclick = ()=> act('run').then(update);
document.getElementById('next').onclick= ()=> act('next').then(update);
document.getElementById('prev').onclick= ()=> act('prev').then(update);
document.getElementById('clear').onclick=()=> act('clear').then(update);

document.getElementById('auto').onclick = ()=>{
  if(autoTimer){ clearInterval(autoTimer); autoTimer=null; return; }
  autoTimer=setInterval(()=> act('next').then(update), 40);
};

document.addEventListener('keydown',(e)=>{
  if(e.code==='Space'){ e.preventDefault(); if(!btnRun.disabled) btnRun.click(); }
  if(e.key==='c' || e.key==='C'){ document.getElementById('clear').click(); }
});

update();
</script>
</body>
</html>